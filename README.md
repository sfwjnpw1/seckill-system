# 秒杀业务系统 (Seckill System)

基于Spring Cloud微服务架构的高并发秒杀系统，重现了简历中描述的技术栈和核心功能。

## 项目概述

本项目是一个完整的秒杀业务系统，采用微服务架构设计，实现了用户认证、商品管理、秒杀活动、订单处理等核心功能。系统通过Redis缓存、RabbitMQ消息队列、分布式锁等技术手段，有效解决了高并发场景下的性能问题和数据一致性问题。

## 技术栈

### 后端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 3.2.5 | 微服务开发框架 |
| Spring Cloud | 2023.0.1 | 微服务治理 |
| Spring Cloud Gateway | - | API网关 |
| Nacos | 2.2.3 | 服务注册与发现、配置中心 |
| MySQL | 8.0 | 关系型数据库 |
| Redis | 7.x | 缓存、分布式锁 |
| Redisson | 3.27.1 | 分布式锁实现 |
| RabbitMQ | 3.12 | 消息队列 |
| ElasticSearch | 8.11.0 | 商品搜索 |
| MyBatis Plus | 3.5.5 | ORM框架 |
| JWT | 0.12.5 | 身份认证 |

### 前端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.x | 前端框架 |
| Vite | - | 构建工具 |
| TypeScript | - | 类型安全 |
| Tailwind CSS | 4.x | CSS框架 |
| Wouter | - | 路由管理 |

### 部署技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Docker | - | 容器化 |
| Docker Compose | - | 容器编排 |
| Nginx | - | 前端服务器 |

## 系统架构

系统采用微服务架构，共包含以下服务：

```
┌─────────────────────────────────────────────────────────────┐
│                         用户/浏览器                          │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │  Nginx (前端)   │
                  └────────┬─────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │  API Gateway    │
                  │   (端口: 8080)  │
                  └────────┬─────────┘
                           │
        ┌──────────────────┼──────────────────┬──────────────┐
        ▼                  ▼                  ▼              ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Auth Service │  │Product Service│  │Seckill Service│  │Order Service │
│  (端口:8081) │  │  (端口:8082)  │  │  (端口:8083)  │  │  (端口:8084) │
└──────┬───────┘  └──────┬────────┘  └──────┬────────┘  └──────┬───────┘
       │                 │                  │                  │
       └─────────────────┴──────────────────┴──────────────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    ▼              ▼              ▼
            ┌──────────────┐ ┌──────────┐ ┌──────────────┐
            │    MySQL     │ │  Redis   │ │  RabbitMQ    │
            │ (端口:3306)  │ │(端口:6379)│ │ (端口:5672)  │
            └──────────────┘ └──────────┘ └──────────────┘
                    │              │
                    ▼              ▼
            ┌──────────────┐ ┌──────────────┐
            │    Nacos     │ │ElasticSearch │
            │ (端口:8848)  │ │ (端口:9200)  │
            └──────────────┘ └──────────────┘
```

## 核心功能

### 1. 用户认证服务 (seckill-auth)

**功能描述：**实现用户注册、登录和JWT身份认证功能。

**技术要点：**
- 使用BCrypt进行密码加密存储
- 生成JWT Token用于身份验证
- 使用ThreadLocal传递用户上下文，避免重复解析Token

**主要接口：**
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 用户登录
- `GET /auth/info` - 获取用户信息

### 2. 商品服务 (seckill-product)

**功能描述：**管理商品信息和秒杀活动，提供商品搜索功能。

**技术要点：**
- 使用Redis实现二级缓存，提升查询性能
- 实现缓存预热机制，系统启动时加载热点数据
- 集成ElasticSearch实现商品搜索（支持分词、高亮）
- 解决缓存穿透、击穿、雪崩问题

**主要接口：**
- `GET /product/list` - 获取商品列表
- `GET /product/{id}` - 获取商品详情
- `GET /product/seckill/list` - 获取秒杀活动列表
- `GET /product/seckill/{id}` - 获取秒杀活动详情

### 3. 秒杀核心服务 (seckill-seckill)

**功能描述：**处理秒杀请求，实现高并发下的防超卖和异步处理。

**技术要点：**
- 使用隐藏路径机制防止恶意请求
- Redis预减库存，减轻数据库压力
- Redisson分布式锁防止超卖
- Redis Stream异步处理秒杀订单
- 数据库乐观锁作为最后防线

**主要接口：**
- `GET /seckill/path/{activityId}` - 获取秒杀路径
- `POST /seckill/doSeckill/{path}` - 执行秒杀
- `GET /seckill/result/{activityId}` - 查询秒杀结果

### 4. 订单服务 (seckill-order)

**功能描述：**管理订单，实现订单自动取消功能。

**技术要点：**
- RabbitMQ延迟队列实现订单自动取消
- 订单超时未支付自动恢复库存
- 订单状态机管理

**主要接口：**
- `GET /order/{orderSn}` - 获取订单详情
- `POST /order/pay/{orderSn}` - 支付订单

## 数据库设计

系统包含以下核心数据表：

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `t_user` | 用户表 | id, username, password, phone, score |
| `t_product` | 商品表 | id, name, price, stock, status |
| `t_seckill_activity` | 秒杀活动表 | id, product_id, seckill_price, seckill_stock, start_time, end_time, version |
| `t_seckill_order` | 秒杀订单表 | id, user_id, activity_id |
| `t_order` | 订单表 | id, order_sn, user_id, product_id, seckill_activity_id, status |

详细的表结构和初始化数据请参考 `database/init.sql` 文件。

## 快速开始

### 前置要求

- Docker 20.10+
- Docker Compose 2.0+
- 8GB+ 可用内存
- 20GB+ 可用磁盘空间

### 一键启动

1. 克隆项目到本地
2. 进入项目目录
3. 执行启动脚本：

```bash
cd seckill_project
./start.sh
```

启动脚本会自动完成以下操作：
- 构建所有Java微服务的Docker镜像
- 启动所有中间件（MySQL、Redis、RabbitMQ、Nacos、ElasticSearch）
- 启动所有微服务
- 启动前端服务

### 访问系统

启动完成后，可以通过以下地址访问系统：

| 服务 | 地址 | 说明 |
|------|------|------|
| 前端界面 | http://localhost | 用户界面 |
| API网关 | http://localhost:8080 | 后端API入口 |
| Nacos控制台 | http://localhost:8848/nacos | 用户名/密码: nacos/nacos |
| RabbitMQ控制台 | http://localhost:15672 | 用户名/密码: guest/guest |

### 测试账号

系统已预置以下测试账号：

| 用户名 | 密码 | 积分 |
|--------|------|------|
| testuser1 | password | 100 |
| testuser2 | password | 200 |
| testuser3 | password | 150 |

## 项目结构

```
seckill_project/
├── backend/                    # 后端微服务
│   ├── pom.xml                # 父POM文件
│   ├── seckill-gateway/       # API网关
│   ├── seckill-auth/          # 用户认证服务
│   ├── seckill-product/       # 商品服务
│   ├── seckill-seckill/       # 秒杀核心服务
│   └── seckill-order/         # 订单服务
├── frontend/                   # 前端项目（Vue 3）
│   ├── client/                # 前端源码
│   │   ├── src/
│   │   │   ├── pages/         # 页面组件
│   │   │   ├── components/    # UI组件
│   │   │   └── App.tsx        # 主应用
│   │   └── public/            # 静态资源
│   └── dist/                  # 构建产物
├── database/                   # 数据库脚本
│   └── init.sql               # 初始化SQL
├── docker-compose.yml         # Docker编排配置
├── start.sh                   # 一键启动脚本
└── README.md                  # 项目文档
```

## 核心技术实现

### 高并发防超卖方案

系统采用多层防护机制确保高并发场景下不会出现超卖：

**第一层：Redis预减库存**
在秒杀开始前，将库存数据加载到Redis中。用户请求到达时，先在Redis中扣减库存，如果Redis中库存不足，直接返回失败，避免请求打到数据库。

**第二层：Redisson分布式锁**
使用Redisson实现的分布式锁，确保同一时刻只有一个线程能够操作库存，防止并发扣减导致的数据不一致。

**第三层：数据库乐观锁**
在数据库层面使用version字段实现乐观锁，更新库存时检查版本号，确保数据的最终一致性。

### 异步秒杀处理

系统使用Redis Stream作为消息队列，实现秒杀请求的异步处理：

1. 用户提交秒杀请求后，系统立即返回"排队中"状态
2. 将秒杀请求发送到Redis Stream
3. 后台消费者异步处理秒杀请求，创建订单
4. 用户可以通过轮询接口查询秒杀结果

这种设计大大提升了系统的吞吐量，避免了同步处理带来的性能瓶颈。

### 订单自动取消

系统使用RabbitMQ的延迟队列（TTL + Dead Letter Exchange）实现订单自动取消：

1. 订单创建时，发送一条带有30分钟TTL的消息到RabbitMQ
2. 如果订单在30分钟内未支付，消息过期后进入死信队列
3. 订单服务监听死信队列，自动取消超时订单并恢复库存

### 缓存优化策略

系统实现了完善的缓存机制：

**缓存预热：**系统启动时，自动将热点商品和秒杀活动数据加载到Redis，避免冷启动时的缓存穿透。

**缓存穿透防护：**对于不存在的数据，在Redis中缓存空值，防止恶意请求穿透到数据库。

**缓存击穿防护：**使用互斥锁机制，当热点数据过期时，只允许一个线程去数据库加载数据，其他线程等待。

**缓存雪崩防护：**为不同的缓存key设置随机的过期时间，避免大量key同时过期。

## 运维管理

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f seckill-gateway
docker-compose logs -f seckill-auth
```

### 停止系统

```bash
# 停止所有服务
docker-compose down

# 停止并删除所有数据
docker-compose down -v
```

### 重启服务

```bash
# 重启特定服务
docker-compose restart seckill-auth

# 重启所有服务
docker-compose restart
```

## 性能优化建议

### 生产环境优化

1. **数据库优化：**
   - 为常用查询字段添加索引
   - 配置主从复制，读写分离
   - 定期分析慢查询日志

2. **Redis优化：**
   - 使用Redis Cluster实现分布式缓存
   - 配置持久化策略（RDB + AOF）
   - 监控内存使用情况

3. **微服务优化：**
   - 增加服务实例数量，实现负载均衡
   - 配置合理的JVM参数
   - 实现服务降级和熔断机制

4. **网关优化：**
   - 配置限流策略，防止恶意攻击
   - 启用HTTPS加密传输
   - 配置CORS跨域策略

## 常见问题

### Q1: 启动失败，提示端口被占用

**解决方案：**检查本地是否有其他服务占用了以下端口：3306, 6379, 5672, 8848, 9200, 8080-8084。可以修改 `docker-compose.yml` 中的端口映射。

### Q2: 服务启动后无法访问

**解决方案：**等待1-2分钟，让所有服务完全启动。可以通过 `docker-compose ps` 查看服务状态，确保所有服务都是 `Up` 状态。

### Q3: Nacos服务注册失败

**解决方案：**确保Nacos服务已经完全启动。可以访问 http://localhost:8848/nacos 检查Nacos控制台是否可用。

### Q4: 前端无法连接后端

**解决方案：**检查API网关是否正常运行。前端默认通过 http://localhost:8080 访问后端服务。

## 技术亮点

本项目完整实现了简历中描述的所有技术要点：

✅ **微服务架构：**采用Spring Cloud构建微服务体系，实现服务注册、发现和配置管理

✅ **高并发处理：**使用Redis缓存、分布式锁、异步消息队列等技术应对高并发场景

✅ **防超卖机制：**多层防护（Redis预减库存 + 分布式锁 + 数据库乐观锁）确保数据一致性

✅ **异步处理：**Redis Stream实现秒杀请求的异步处理，提升系统吞吐量

✅ **延迟队列：**RabbitMQ延迟队列实现订单自动取消功能

✅ **搜索优化：**ElasticSearch实现商品搜索，支持分词、高亮显示

✅ **身份认证：**JWT Token实现无状态身份认证，ThreadLocal传递用户上下文

✅ **容器化部署：**Docker Compose实现一键部署，简化运维流程

## 未来扩展

系统可以进一步扩展以下功能：

- **用户签到系统：**实现每日签到获取积分功能
- **支付集成：**接入第三方支付平台（支付宝、微信支付）
- **消息推送：**实现秒杀结果的实时推送
- **数据统计：**添加秒杀活动的数据分析和可视化
- **限流熔断：**集成Sentinel实现服务限流和熔断
- **链路追踪：**集成Skywalking实现分布式链路追踪
- **日志收集：**集成ELK实现日志集中管理

## 许可证

本项目仅供学习和参考使用。

## 联系方式

如有问题或建议，欢迎通过以下方式联系：

- 项目地址：[GitHub Repository]
- 邮箱：ycy221100@163.com

---

**作者：** Manus AI  
**最后更新：** 2024年11月
